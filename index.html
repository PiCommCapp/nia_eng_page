<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIA Engineering Portal</title>
    <meta name="description" content="Lightning-fast access to engineering systems for broadcast/AV infrastructure">
    <!-- Add theme-color for mobile browsers -->
    <meta name="theme-color" content="#2c3e50">
    <!-- Add favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        /* Critical CSS for immediate rendering */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #f4f5f7;
            --text-color: #333;
            --link-color: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .status-indicator {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-left: 1rem;
        }

        .status-online {
            background-color: var(--success-color);
            color: white;
        }

        .status-offline {
            background-color: var(--danger-color);
            color: white;
        }

        .categories {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 1rem 0;
        }

        .category {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 1rem;
            width: calc(25% - 1rem);
            min-width: 250px;
            flex-grow: 1;
        }

        .category h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        .links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .link-card {
            display: block;
            padding: 0.75rem;
            text-decoration: none;
            color: var(--text-color);
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .link-card:hover, .link-card:focus {
            background-color: #f8f9fa;
            border-color: #ddd;
            transform: translateY(-1px);
            outline: none;
        }

        .link-card.focused {
            box-shadow: 0 0 0 2px var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .system-name {
            display: block;
            font-weight: 600;
            color: var(--link-color);
        }

        .system-details {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .search-container {
            padding: 1rem 0;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-results {
            margin-top: 1rem;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-style: italic;
            color: #666;
        }

        .error-message {
            background-color: #fff3f3;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .shortcuts-help {
            background-color: #f8f9fa;
            border: 1px solid #eee;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
            display: none;
        }

        .shortcuts-help.active {
            display: block;
        }

        .shortcuts-help kbd {
            background-color: #eee;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.875rem;
        }

        .update-notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: var(--warning-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            margin-top: 2rem;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .category {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-content">
            <h1>NIA Engineering Portal</h1>
            <div>
                <span id="online-status" class="status-indicator">Checking...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Search systems... (Press / to focus)" id="searchInput">
        </div>

        <div class="shortcuts-help" id="shortcutsHelp">
            <h3>Keyboard Shortcuts</h3>
            <p><kbd>/</kbd> - Focus search</p>
            <p><kbd>Esc</kbd> - Clear search / Close shortcuts help</p>
            <p><kbd>?</kbd> - Show/hide shortcuts help</p>
            <p><kbd>Tab</kbd> - Navigate through links</p>
            <p><kbd>Enter</kbd> - Open selected link</p>
            <p><kbd>1</kbd> - <kbd>9</kbd> - Jump to category</p>
        </div>

        <div class="search-results" id="searchResults">
            <h2>Search Results</h2>
            <div class="links" id="searchResultsLinks">
                <!-- Search results will be populated here -->
            </div>
        </div>

        <div class="categories" id="categoriesContainer">
            <div class="loading" id="loadingIndicator">
                Loading system categories...
            </div>
            <!-- Categories will be populated from bookmarks.html -->
        </div>
    </div>

    <footer>
        <div class="container">
            <p>NIA Engineering Portal - Press ? for keyboard shortcuts</p>
        </div>
    </footer>

    <!-- Load parser script -->
    <script src="js/bookmarks-parser.js"></script>
    <!-- Load service worker registration -->
    <script src="js/service-worker-register.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('NIA Engineering Portal loaded');

            // Elements
            const categoriesContainer = document.getElementById('categoriesContainer');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchResultsLinks = document.getElementById('searchResultsLinks');
            const shortcutsHelp = document.getElementById('shortcutsHelp');

            // Create parser instance
            const parser = new BookmarksParser();

            // Store categories for keyboard navigation
            let allCategories = [];
            let allLinks = [];
            let currentFocusIndex = -1;

            // Load and parse bookmarks
            parser.loadBookmarks('bookmarks.html')
                .then(categories => {
                    // Store categories
                    allCategories = categories;

                    // Remove loading indicator
                    loadingIndicator.remove();

                    // Render categories
                    renderCategories(categories);

                    // Set up search
                    setupSearch(parser);

                    // Set up keyboard shortcuts
                    setupKeyboardShortcuts();

                    // Collect all links for keyboard navigation
                    allLinks = document.querySelectorAll('.link-card');
                })
                .catch(error => {
                    console.error('Failed to load bookmarks:', error);
                    showError(`Failed to load bookmarks: ${error.message}`);
                });

            /**
             * Render categories and links
             * @param {Array} categories - Categories to render
             */
            function renderCategories(categories) {
                categories.forEach((category, index) => {
                    // Skip empty categories
                    if (category.links.length === 0 && category.subcategories.length === 0) {
                        return;
                    }

                    // Create category element
                    const categoryElement = document.createElement('div');
                    categoryElement.className = 'category';
                    categoryElement.setAttribute('data-category-index', index);

                    // Add category header
                    const categoryHeader = document.createElement('h2');

                    // Add number shortcut for first 9 categories
                    if (index < 9) {
                        categoryHeader.textContent = `${index + 1}. ${category.name}`;
                    } else {
                        categoryHeader.textContent = category.name;
                    }

                    categoryElement.appendChild(categoryHeader);

                    // Create links container
                    const linksContainer = document.createElement('div');
                    linksContainer.className = 'links';
                    categoryElement.appendChild(linksContainer);

                    // Add links
                    category.links.forEach(link => {
                        const linkElement = createLinkElement(link);
                        linksContainer.appendChild(linkElement);
                    });

                    // Add to DOM
                    categoriesContainer.appendChild(categoryElement);

                    // Process subcategories
                    if (category.subcategories && category.subcategories.length > 0) {
                        category.subcategories.forEach(subcat => {
                            // Add subcategory with proper indentation or styling
                            // This is a simplified approach; you might want to nest them properly
                            const subcatElement = document.createElement('div');
                            subcatElement.className = 'category';

                            const subcatHeader = document.createElement('h2');
                            subcatHeader.textContent = `${category.name} > ${subcat.name}`;
                            subcatElement.appendChild(subcatHeader);

                            const subcatLinks = document.createElement('div');
                            subcatLinks.className = 'links';
                            subcatElement.appendChild(subcatLinks);

                            subcat.links.forEach(link => {
                                const linkElement = createLinkElement(link);
                                subcatLinks.appendChild(linkElement);
                            });

                            categoriesContainer.appendChild(subcatElement);
                        });
                    }
                });
            }

            /**
             * Create a link element
             * @param {Object} link - Link data
             * @returns {Element} - Link element
             */
            function createLinkElement(link) {
                const linkElement = document.createElement('a');
                linkElement.className = 'link-card';
                linkElement.href = link.url;
                linkElement.target = '_blank'; // Open in new tab
                linkElement.setAttribute('tabindex', '0'); // Make focusable

                const systemName = document.createElement('span');
                systemName.className = 'system-name';
                systemName.textContent = link.title;
                linkElement.appendChild(systemName);

                // Extract domain or IP from URL
                let systemDetails = '';
                try {
                    const url = new URL(link.url);
                    systemDetails = url.hostname;
                } catch (e) {
                    systemDetails = link.url;
                }

                const detailsElement = document.createElement('span');
                detailsElement.className = 'system-details';
                detailsElement.textContent = systemDetails;
                linkElement.appendChild(detailsElement);

                return linkElement;
            }

            /**
             * Set up search functionality
             * @param {BookmarksParser} parser - Parser instance
             */
            function setupSearch(parser) {
                searchInput.addEventListener('input', debounce(function(e) {
                    const query = e.target.value.trim();

                    if (query.length < 2) {
                        searchResults.classList.remove('active');
                        categoriesContainer.style.display = 'flex';
                        return;
                    }

                    const results = parser.search(query);
                    searchResultsLinks.innerHTML = '';

                    if (results.length === 0) {
                        const noResults = document.createElement('p');
                        noResults.textContent = 'No matching systems found.';
                        searchResultsLinks.appendChild(noResults);
                    } else {
                        results.forEach(result => {
                            const linkElement = createLinkElement(result.link);

                            // Add category path info
                            const pathElement = document.createElement('span');
                            pathElement.className = 'system-details';
                            pathElement.textContent = `Category: ${result.path.join(' > ')}`;
                            linkElement.appendChild(pathElement);

                            searchResultsLinks.appendChild(linkElement);
                        });
                    }

                    searchResults.classList.add('active');
                    categoriesContainer.style.display = 'none';

                    // Update links for keyboard navigation
                    allLinks = document.querySelectorAll('.link-card');
                    currentFocusIndex = -1;
                }, 300));

                // Reset when search is cleared
                searchInput.addEventListener('search', function(e) {
                    if (e.target.value === '') {
                        searchResults.classList.remove('active');
                        categoriesContainer.style.display = 'flex';

                        // Update links for keyboard navigation
                        allLinks = document.querySelectorAll('.link-card');
                        currentFocusIndex = -1;
                    }
                });
            }

            /**
             * Set up keyboard shortcuts
             */
            function setupKeyboardShortcuts() {
                // Global keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    // Focus search with /
                    if (e.key === '/' && document.activeElement !== searchInput) {
                        e.preventDefault();
                        searchInput.focus();
                    }

                    // Show/hide shortcuts help with ?
                    if (e.key === '?') {
                        e.preventDefault();
                        shortcutsHelp.classList.toggle('active');
                    }

                    // Close shortcuts help with Escape
                    if (e.key === 'Escape') {
                        if (shortcutsHelp.classList.contains('active')) {
                            shortcutsHelp.classList.remove('active');
                        } else if (document.activeElement === searchInput) {
                            searchInput.value = '';
                            searchInput.dispatchEvent(new Event('search'));
                        }
                    }

                    // Navigate links with Tab
                    if (e.key === 'Tab') {
                        // Let browser handle tab navigation
                        if (e.shiftKey && currentFocusIndex > 0) {
                            currentFocusIndex--;
                        } else if (!e.shiftKey && currentFocusIndex < allLinks.length - 1) {
                            currentFocusIndex++;
                        }
                    }

                    // Quick category access with number keys 1-9
                    if (!isNaN(parseInt(e.key)) && e.key >= '1' && e.key <= '9') {
                        const index = parseInt(e.key) - 1;
                        const categoryElement = document.querySelector(`.category[data-category-index="${index}"]`);
                        if (categoryElement) {
                            e.preventDefault();
                            categoryElement.scrollIntoView({ behavior: 'smooth' });

                            // Focus the first link in this category
                            const firstLink = categoryElement.querySelector('.link-card');
                            if (firstLink) {
                                firstLink.focus();
                                updateFocus(Array.from(allLinks).indexOf(firstLink));
                            }
                        }
                    }
                });

                // Handle focus events
                document.addEventListener('focusin', function(e) {
                    if (e.target.classList.contains('link-card')) {
                        const index = Array.from(allLinks).indexOf(e.target);
                        updateFocus(index);
                    }
                });
            }

            /**
             * Update focus state for keyboard navigation
             * @param {number} index - Index of focused element
             */
            function updateFocus(index) {
                // Remove previous focus
                if (currentFocusIndex >= 0 && currentFocusIndex < allLinks.length) {
                    allLinks[currentFocusIndex].classList.remove('focused');
                }

                // Set new focus
                currentFocusIndex = index;

                // Add focus class
                if (currentFocusIndex >= 0 && currentFocusIndex < allLinks.length) {
                    allLinks[currentFocusIndex].classList.add('focused');
                }
            }

            /**
             * Show error message
             * @param {string} message - Error message
             */
            function showError(message) {
                loadingIndicator.remove();

                const errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                errorElement.textContent = message;
                categoriesContainer.appendChild(errorElement);
            }

            /**
             * Debounce function for search input
             * @param {Function} func - Function to debounce
             * @param {number} delay - Delay in milliseconds
             */
            function debounce(func, delay) {
                let timeout;
                return function() {
                    const context = this;
                    const args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        func.apply(context, args);
                    }, delay);
                };
            }
        });
    </script>
</body>
</html>
